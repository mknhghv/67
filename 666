-- 服務
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local Camera = Workspace.CurrentCamera

-- 設定表
local Settings = {
    AutoClick = true,
    ClickDelay = 0.12,
    Distance = 5000,
    AttackMobs = true,
    AttackPlayers = false,
    AutoV4 = false,
    
    -- 移動加速
    TranslateAccelEnabled = false,
    TranslateAccelSpeed = 50,           -- 預設加速值
    
    -- ESP
    ESP_Main = false,
    ESP_NameDistance = false,
    ESP_Health = false,
    ESP_Tracer = false
}

-- 全域變數
local FastAttack = nil
local autoV4Task = nil
local translateConnection = nil
local ScreenGui = nil
local MainFrame = nil
local ESPElements = {}

-- 安全等待
local function SafeWaitForChild(parent, childName, timeout)
    timeout = timeout or 10
    local success, result = pcall(function()
        return parent:WaitForChild(childName, timeout)
    end)
    if not success or not result then
        warn("未找到組件: " .. childName)
    end
    return result
end

-- FastAttack 核心組件
local function CheckAndGetCoreComponents()
    local Remotes = SafeWaitForChild(ReplicatedStorage, "Remotes")
    local Modules = SafeWaitForChild(ReplicatedStorage, "Modules")
    local Net = Modules and SafeWaitForChild(Modules, "Net")
    local RegisterAttack = Net and SafeWaitForChild(Net, "RE/RegisterAttack")
    local RegisterHit = Net and SafeWaitForChild(Net, "RE/RegisterHit")
    local Enemies = SafeWaitForChild(Workspace, "Enemies")
    return Remotes, Net, RegisterAttack, RegisterHit, Enemies
end

local function IsAlive(character)
    if not character then return false end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health > 0
end

local function GetBestValidPart(target)
    local hrp = target:FindFirstChild("HumanoidRootPart") or target.PrimaryPart
    if hrp then return hrp end
    local head = target:FindFirstChild("Head")
    if head then return head end
    local torso = target:FindFirstChild("UpperTorso") or target:FindFirstChild("Torso")
    if torso then return torso end
    return target:FindFirstChildWhichIsA("BasePart")
end

-- FastAttack 邏輯
FastAttack = {
    IsRunning = true,
    consecutiveFailures = 0,
    maxConsecutiveFailures = 5
}

function FastAttack:Attack(BasePart, OthersEnemies)
    local _, _, ra, rh = CheckAndGetCoreComponents()
    if not (BasePart and OthersEnemies and #OthersEnemies > 0 and ra and rh) then
        self.consecutiveFailures = self.consecutiveFailures + 1
        if self.consecutiveFailures >= self.maxConsecutiveFailures then
            self.consecutiveFailures = 0
        end
        return
    end
    self.consecutiveFailures = 0
    ra:FireServer(Settings.ClickDelay)
    rh:FireServer(BasePart, OthersEnemies)
end

function FastAttack:AttackNearest()
    if not self.IsRunning or not Settings.AutoClick then return end
    
    local _, _, _, _, Enemies = CheckAndGetCoreComponents()
    local OthersEnemies = {}
    local closestPart = nil
    local closestDist = Settings.Distance
    
    if Settings.AttackMobs and Enemies then
        for _, e in ipairs(Enemies:GetChildren()) do
            if e == Player.Character or not IsAlive(e) then continue end
            local part = GetBestValidPart(e)
            if part then
                local dist = Player:DistanceFromCharacter(part.Position)
                if dist < closestDist then
                    closestDist = dist
                    closestPart = part
                end
                table.insert(OthersEnemies, {e, part})
            end
        end
    end
    
    if Settings.AttackPlayers then
        for _, p in ipairs(Players:GetPlayers()) do
            if p == Player then continue end
            local char = p.Character
            if not IsAlive(char) then continue end
            local part = GetBestValidPart(char)
            if part then
                local dist = Player:DistanceFromCharacter(part.Position)
                if dist < closestDist then
                    closestDist = dist
                    closestPart = part
                end
                table.insert(OthersEnemies, {char, part})
            end
        end
    end
    
    if #OthersEnemies > 0 then
        self:Attack(closestPart, OthersEnemies)
    end
end

function FastAttack:BladeHits()
    local char = Player.Character
    if not char or not IsAlive(char) then return end
    local tool = char:FindFirstChildOfClass("Tool")
    if tool and tool.ToolTip ~= "Gun" then
        self:AttackNearest()
    end
end

RunService.Heartbeat:Connect(function()
    if Settings.AutoClick and FastAttack.IsRunning then
        FastAttack:BladeHits()
    end
end)

-- Auto V4
local function callAwakeningRemote()
    local bp = Player:FindFirstChild("Backpack")
    if not bp then return end
    local awakening = bp:FindFirstChild("Awakening")
    if not awakening then return end
    local rf = awakening:FindFirstChild("RemoteFunction")
    if not rf or not rf:IsA("RemoteFunction") then return end
    
    pcall(function()
        rf:InvokeServer(true)
    end)
end

local function toggleAutoV4(enable)
    if autoV4Task then
        task.cancel(autoV4Task)
        autoV4Task = nil
    end
    if enable then
        autoV4Task = task.spawn(function()
            while Settings.AutoV4 do
                callAwakeningRemote()
                task.wait(1)
            end
        end)
    end
end

-- 移動加速
local function toggleTranslateAccel(enable)
    if translateConnection then
        translateConnection:Disconnect()
        translateConnection = nil
    end
    
    if enable then
        translateConnection = RunService.Heartbeat:Connect(function()
            local char = Player.Character
            if not char or not char:FindFirstChild("Humanoid") then return end
            
            local humanoid = char.Humanoid
            if humanoid.MoveDirection.Magnitude > 0 then
                local accel = humanoid.MoveDirection * (Settings.TranslateAccelSpeed or 50) / 30
                char:TranslateBy(accel)
            end
        end)
    end
end

-- ESP 相關函數
local function CleanupPlayerESP(player)
    if not ESPElements[player.UserId] then return end
    
    if ESPElements[player.UserId].NameHealthESP then
        ESPElements[player.UserId].NameHealthESP:Destroy()
    end
    if ESPElements[player.UserId].NameHealthUpdateConn then
        ESPElements[player.UserId].NameHealthUpdateConn:Disconnect()
    end
    
    if ESPElements[player.UserId].Tracer then
        ESPElements[player.UserId].Tracer:Remove()
    end
    if ESPElements[player.UserId].TracerConn then
        ESPElements[player.UserId].TracerConn:Disconnect()
    end
    
    ESPElements[player.UserId] = nil
end

local function CreateNameDistanceHealthESP(player)
    if player == Player or not player.Character or not player.Character:FindFirstChild("Head") then return end
    
    local head = player.Character.Head
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "NameHealthESP"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 140, 0, 60)
    billboard.StudsOffset = Vector3.new(0, 3.8, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head
    
    local nameLabel = Instance.new("TextLabel", billboard)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Size = UDim2.new(1,0,0.33,0)
    nameLabel.Text = player.Name
    nameLabel.TextColor3 = Color3.new(1,1,1)
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamSemibold
    
    local healthLabel = Instance.new("TextLabel", billboard)
    healthLabel.BackgroundTransparency = 1
    healthLabel.Position = UDim2.new(0,0,0.33,0)
    healthLabel.Size = UDim2.new(1,0,0.33,0)
    healthLabel.TextColor3 = Color3.new(0,1,0)
    healthLabel.TextScaled = true
    healthLabel.Font = Enum.Font.Gotham
    
    local distLabel = Instance.new("TextLabel", billboard)
    distLabel.BackgroundTransparency = 1
    distLabel.Position = UDim2.new(0,0,0.66,0)
    distLabel.Size = UDim2.new(1,0,0.33,0)
    distLabel.TextColor3 = Color3.new(1,0.6,0)
    distLabel.TextScaled = true
    distLabel.Font = Enum.Font.Gotham
    
    local conn = RunService.RenderStepped:Connect(function()
        if not billboard.Parent or not Player.Character then return end
        local hrp = Player.Character:FindFirstChild("HumanoidRootPart")
        local tHrp = player.Character:FindFirstChild("HumanoidRootPart")
        if hrp and tHrp then
            local dist = (hrp.Position - tHrp.Position).Magnitude
            distLabel.Text = string.format("%.1fm", dist)
        end
        
        local hum = player.Character:FindFirstChild("Humanoid")
        if hum then
            local hp = math.floor(hum.Health)
            local max = math.floor(hum.MaxHealth)
            local percent = hp / max
            
            if percent > 0.7 then
                healthLabel.TextColor3 = Color3.new(0,1,0)
            elseif percent > 0.3 then
                healthLabel.TextColor3 = Color3.new(1,1,0)
            else
                healthLabel.TextColor3 = Color3.new(1,0,0)
            end
            
            healthLabel.Text = string.format("HP: %d/%d", hp, max)
        end
    end)
    
    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].NameHealthESP = billboard
    ESPElements[player.UserId].NameHealthUpdateConn = conn
end

local function CreateTracerESP(player)
    if player == Player then return end
    
    local tracer = Drawing.new("Line")
    tracer.Color = Color3.new(1, 0.2, 0.2)
    tracer.Thickness = 2
    tracer.Transparency = 0.7
    tracer.Visible = false
    
    local conn = RunService.RenderStepped:Connect(function()
        tracer.Visible = false
        if not Settings.ESP_Main or not Settings.ESP_Tracer then return end
        
        local char = player.Character
        if not char or not Player.Character then return end
        
        local target = char:FindFirstChild("HumanoidRootPart")
        if target then
            local screenPos, onScreen = Camera:WorldToViewportPoint(target.Position)
            if onScreen then
                tracer.Visible = true
                tracer.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
            end
        end
    end)
    
    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].Tracer = tracer
    ESPElements[player.UserId].TracerConn = conn
end

local function UpdatePlayerESP(player)
    if player == Player then return end
    
    CleanupPlayerESP(player)
    
    if not Settings.ESP_Main or not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        return
    end
    
    CreateTracerESP(player)
    
    if Settings.ESP_NameDistance or Settings.ESP_Health then
        CreateNameDistanceHealthESP(player)
    end
end

local function UpdateAllESP()
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= Player then
            UpdatePlayerESP(p)
        end
    end
end

-- 玩家加入/重生處理
Players.PlayerAdded:Connect(function(p)
    if p == Player then return end
    p.CharacterAdded:Connect(function()
        task.wait(0.5)
        UpdatePlayerESP(p)
    end)
    p.CharacterRemoving:Connect(function()
        CleanupPlayerESP(p)
    end)
end)

-- UI 創建（增加移動加速 & ESP 區塊）
local function CreateUI()
    if ScreenGui then ScreenGui:Destroy() end
    
    ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "UltimateHub"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = PlayerGui
    
    MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 340, 0, 580)
    MainFrame.Position = UDim2.new(0.5, -170, 0.5, -290)
    MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = ScreenGui
    
    local corner = Instance.new("UICorner", MainFrame)
    corner.CornerRadius = UDim.new(0, 12)
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1,0,0,50)
    title.BackgroundColor3 = Color3.fromRGB(20,20,25)
    title.Text = "✦ Ultimate Hub - Blox Fruits"
    title.TextColor3 = Color3.new(1,1,1)
    title.TextScaled = true
    title.Font = Enum.Font.GothamBold
    title.Parent = MainFrame
    
    local titleCorner = Instance.new("UICorner", title)
    titleCorner.CornerRadius = UDim.new(0, 12)
    
    -- 關閉按鈕
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0,35,0,35)
    closeBtn.Position = UDim2.new(1,-40,0,8)
    closeBtn.BackgroundColor3 = Color3.fromRGB(220,40,40)
    closeBtn.Text = "✕"
    closeBtn.TextColor3 = Color3.new(1,1,1)
    closeBtn.TextScaled = true
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = title
    
    local closeCorner = Instance.new("UICorner", closeBtn)
    closeCorner.CornerRadius = UDim.new(0, 17)
    
    closeBtn.MouseButton1Click:Connect(function()
        Settings.AutoV4 = false
        toggleAutoV4(false)
        Settings.TranslateAccelEnabled = false
        toggleTranslateAccel(false)
        for _, p in ipairs(Players:GetPlayers()) do
            CleanupPlayerESP(p)
        end
        ScreenGui:Destroy()
    end)
    
    -- Toggle 函數簡化
    local function MakeToggle(parent, name, posY, default, callback)
        local toggle = Instance.new("TextButton")
        toggle.Size = UDim2.new(1,-20,0,40)
        toggle.Position = UDim2.new(0,10,0,posY)
        toggle.BackgroundColor3 = default and Color3.fromRGB(60,200,60) or Color3.fromRGB(200,60,60)
        toggle.Text = (default and "✅ " or "❌ ") .. name
        toggle.TextColor3 = Color3.new(1,1,1)
        toggle.TextScaled = true
        toggle.Font = Enum.Font.Gotham
        toggle.Parent = parent
        
        local c = Instance.new("UICorner", toggle)
        c.CornerRadius = UDim.new(0,6)
        
        toggle.MouseButton1Click:Connect(function()
            local newState = not (toggle.Text:find("✅") and true or false)
            toggle.BackgroundColor3 = newState and Color3.fromRGB(60,200,60) or Color3.fromRGB(200,60,60)
            toggle.Text = (newState and "✅ " or "❌ ") .. name
            callback(newState)
        end)
        
        return toggle
    end
    
    -- 攻擊相關
    MakeToggle(MainFrame, "自動攻擊", 60, Settings.AutoClick, function(s)
        Settings.AutoClick = s
    end)
    
    MakeToggle(MainFrame, "攻擊怪物", 110, Settings.AttackMobs, function(s)
        Settings.AttackMobs = s
    end)
    
    MakeToggle(MainFrame, "攻擊玩家", 160, Settings.AttackPlayers, function(s)
        Settings.AttackPlayers = s
    end)
    
    MakeToggle(MainFrame, "自動V4", 210, Settings.AutoV4, function(s)
        Settings.AutoV4 = s
        toggleAutoV4(s)
    end)
    
    -- 移動加速
    MakeToggle(MainFrame, "移動加速", 260, Settings.TranslateAccelEnabled, function(s)
        Settings.TranslateAccelEnabled = s
        toggleTranslateAccel(s)
    end)
    
    -- 加速滑桿
    local speedLabel = Instance.new("TextLabel")
    speedLabel.Size = UDim2.new(1,-20,0,25)
    speedLabel.Position = UDim2.new(0,10,0,305)
    speedLabel.BackgroundTransparency = 1
    speedLabel.Text = "加速倍率: " .. Settings.TranslateAccelSpeed
    speedLabel.TextColor3 = Color3.new(1,1,1)
    speedLabel.TextScaled = true
    speedLabel.Font = Enum.Font.Gotham
    speedLabel.TextXAlignment = Enum.TextXAlignment.Left
    speedLabel.Parent = MainFrame
    
    local speedSlider = Instance.new("Frame")
    speedSlider.Size = UDim2.new(1,-20,0,20)
    speedSlider.Position = UDim2.new(0,10,0,330)
    speedSlider.BackgroundColor3 = Color3.fromRGB(50,50,55)
    speedSlider.Parent = MainFrame
    Instance.new("UICorner", speedSlider).CornerRadius = UDim.new(0,10)
    
    local speedBar = Instance.new("Frame", speedSlider)
    speedBar.Size = UDim2.new((Settings.TranslateAccelSpeed/200),0,1,0)
    speedBar.BackgroundColor3 = Color3.fromRGB(80,200,255)
    Instance.new("UICorner", speedBar).CornerRadius = UDim.new(0,10)
    
    local dragging = false
    speedBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if not dragging or input.UserInputType ~= Enum.UserInputType.MouseMovement then return end
        
        local mouse = Player:GetMouse()
        local relX = math.clamp((mouse.X - speedSlider.AbsolutePosition.X) / speedSlider.AbsoluteSize.X, 0, 1)
        local value = math.floor(relX * 200 + 0.5)
        value = math.max(10, math.min(200, value))  -- 限制範圍 10~200
        
        speedBar.Size = UDim2.new(relX, 0, 1, 0)
        speedLabel.Text = "加速倍率: " .. value
        Settings.TranslateAccelSpeed = value
    end)
    
    -- ESP 區塊
    local espTitle = Instance.new("TextLabel")
    espTitle.Size = UDim2.new(1,-20,0,30)
    espTitle.Position = UDim2.new(0,10,0,365)
    espTitle.BackgroundTransparency = 1
    espTitle.Text = "ESP 透視設定"
    espTitle.TextColor3 = Color3.fromRGB(180,180,255)
    espTitle.TextScaled = true
    espTitle.Font = Enum.Font.GothamBold
    espTitle.Parent = MainFrame
    
    MakeToggle(MainFrame, "透視總開關", 400, Settings.ESP_Main, function(s)
        Settings.ESP_Main = s
        UpdateAllESP()
    end)
    
    MakeToggle(MainFrame, "顯示名字+距離", 450, Settings.ESP_NameDistance, function(s)
        Settings.ESP_NameDistance = s
        UpdateAllESP()
    end)
    
    MakeToggle(MainFrame, "顯示血量", 500, Settings.ESP_Health, function(s)
        Settings.ESP_Health = s
        UpdateAllESP()
    end)
    
    MakeToggle(MainFrame, "射線（Tracer）", 550, Settings.ESP_Tracer, function(s)
        Settings.ESP_Tracer = s
        UpdateAllESP()
    end)
end

-- 初始化
CreateUI()

-- 初始更新 ESP
task.spawn(function()
    task.wait(2)
    UpdateAllESP()
end)

print("Ultimate Hub 已載入！包含：快速攻擊 / 自動V4 / 移動加速 / 完整ESP")
