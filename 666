-- 零中心腳本 - 改進版（大範圍、超快攻速 + 玩家專屬透視）
-- 原腳本學習自提供內容，優化為大範圍攻擊（100000）、超快攻速（delay 0.01）、玩家專屬透視
-- 作者：基於原腳本修改

local old
old = hookmetamethod(game:GetService("StarterGui"), "__namecall", newcclosure(function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    if method == "SetCore" and args[1] == "SendNotification" then
        local options = args[2]
        if type(options) == "table" and tostring(options.Title) == "零脚本" and tostring(options.Text) == "小轩制作" then
            local modifiedOptions = table.clone(options)
            modifiedOptions.Text = "1"
            return old(self, modifiedOptions)
        end
    end
    return old(self, ...)
end))

-- 關閉相機抖動
local main = require(game:GetService("ReplicatedStorage").Util.CameraShaker.Main)
local returnnil = function() return nil end
main.StartShake = returnnil
main.ShakeOnce = returnnil
main.ShakeSustain = returnnil
main.CameraShakeInstance = returnnil
main.Shake = returnnil
main.Start = returnnil

game:GetService("StarterGui"):SetCore("SendNotification",{Title = "零脚本", Text = "改進版載入", Duration = 5})
wait(0.1)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- 載入 Orion Library
local OrionLib = loadstring(game:HttpGet('https://raw.githubusercontent.com/shlexware/Orion/main/source'))()

local Window = OrionLib:MakeWindow({
    Name = "零中心 - 改進版",
    HidePremium = false,
    SaveConfig = false,
    ConfigFolder = "LingCenterImproved"
})

OrionLib:MakeNotification({
    Name = "零脚本",
    Content = "改進版載入完成：大範圍、超快攻速、玩家透視",
    Image = "rbxassetid://7734068321",
    Time = 6
})

-- Tabs
local Tab1 = Window:MakeTab({Name = "公告", Icon = "rbxassetid://7734068321"})
local Tab2 = Window:MakeTab({Name = "腳本", Icon = "rbxassetid://7734068321"})
local Tab3 = Window:MakeTab({Name = "秒殺", Icon = "rbxassetid://7734068321"})
local Tab4 = Window:MakeTab({Name = "透視", Icon = "rbxassetid://7734068321"})

-- 公告
Tab1:AddLabel("基於原腳本改進")
Tab1:AddLabel("大範圍攻擊 + 超快攻速 + 玩家專屬透視")

-- 腳本 Tab (保留部分原功能)
Tab2:AddSlider({
    Name = "視角縮放距離",
    Min = 128,
    Max = 10000,
    Default = 128,
    Increment = 1,
    Callback = function(Value)
        Players.LocalPlayer.CameraMaxZoomDistance = Value
    end
})

Tab2:AddButton({Name = "飛行", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/kismile236/rjrym/refs/heads/main/fly.lua"))() end})
Tab2:AddButton({Name = "fps優化", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/kismile236/rjrym/refs/heads/main/fpsboost"))() end})

-- ==================== 改進秒殺功能：大範圍 (100000) + 超快攻速 (delay 0.01) ====================
local Settings = {AutoClick = true, ClickDelay = 0.01}  -- 超快攻速
Settings.Distance = 100000  -- 很大範圍
local _G = _G or getfenv(0)._G
_G.FastAttack = _G.FastAttack ~= nil and _G.FastAttack or true

local function SafeWaitForChild(parent, childName)
    local success, result = pcall(function() return parent:WaitForChild(childName, 10) end)
    if not success or not result then warn("未找到组件: " .. childName) end
    return result
end

local function CheckAndGetCoreComponents()
    local Remotes, Modules, Net, RegisterAttack, RegisterHit, Enemies = nil, nil, nil, nil, nil, nil
    while true do
        Remotes = SafeWaitForChild(ReplicatedStorage, "Remotes")
        Modules = SafeWaitForChild(ReplicatedStorage, "Modules")
        Net = Modules and SafeWaitForChild(Modules, "Net") or nil
        RegisterAttack = Net and SafeWaitForChild(Net, "RE/RegisterAttack") or nil
        RegisterHit = Net and SafeWaitForChild(Net, "RE/RegisterHit") or nil
        Enemies = SafeWaitForChild(workspace, "Enemies")
        if Remotes and Modules and Net and RegisterAttack and RegisterHit and Enemies then
            return Remotes, Net, RegisterAttack, RegisterHit, Enemies
        end
        task.wait(1)
    end
end

local function IsAlive(character)
    if not character then return false end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health and humanoid.Health > 0
end

local function GetRandomValidPart(target)
    local allParts = target:GetDescendants()
    local validParts = {}
    local humanoidRootPart = target:FindFirstChild("HumanoidRootPart")
    local boneParts = humanoidRootPart and humanoidRootPart.Parent:GetDescendants() or {}
    for _, part in ipairs(allParts) do
        if part:IsA("BasePart") and part.CanCollide and table.find(boneParts, part) then
            table.insert(validParts, part)
        end
    end
    return #validParts > 0 and validParts[math.random(1, #validParts)] or target:FindFirstChild("HumanoidRootPart")
end

local Module = {}
local _ENV = (getgenv or getrenv or getfenv)()

Module.FastAttack = (function()
    if _ENV.rz_FastAttack then return _ENV.rz_FastAttack end
    local FastAttack = {
        Distance = 100000,  -- 大範圍
        attackMobs = false,  -- 只攻擊玩家，關閉怪物
        attackPlayers = true,
        Equipped = nil,
        IsRunning = _G.FastAttack,
        consecutiveFailures = 0,
        maxConsecutiveFailures = 5
    }

    local function ProcessEnemies(OthersEnemies, Folder)
        if not Folder or not FastAttack.attackMobs then return nil end
        local BasePart = nil
        for _, Enemy in Folder:GetChildren() do
            if Enemy == LocalPlayer.Character or not IsAlive(Enemy) then continue end
            local foundPart = GetRandomValidPart(Enemy)
            if foundPart and LocalPlayer:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                table.insert(OthersEnemies, {Enemy, foundPart})
                BasePart = foundPart
            end
        end
        return BasePart
    end

    local function ProcessRealPlayers(OthersEnemies)
        if not FastAttack.attackPlayers then return nil end
        local BasePart = nil
        for _, OtherPlayer in Players:GetPlayers() do
            if OtherPlayer == LocalPlayer then continue end
            local OtherChar = OtherPlayer.Character
            if not IsAlive(OtherChar) then continue end
            local foundPart = GetRandomValidPart(OtherChar)
            if foundPart and LocalPlayer:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                table.insert(OthersEnemies, {OtherChar, foundPart})
                BasePart = foundPart
            end
        end
        return BasePart
    end

    function FastAttack:Attack(BasePart, OthersEnemies)
        local _, Net, temp_RegisterAttack, temp_RegisterHit, _ = CheckAndGetCoreComponents()
        if not (BasePart and OthersEnemies and #OthersEnemies > 0 and temp_RegisterAttack and temp_RegisterHit) then
            self.consecutiveFailures = self.consecutiveFailures + 1
            if self.consecutiveFailures >= self.maxConsecutiveFailures then
                self.consecutiveFailures = 0
                self.Equipped = LocalPlayer.Character and IsAlive(LocalPlayer.Character) and LocalPlayer.Character:FindFirstChildOfClass("Tool")
            end
            task.delay(0.5, function() self:AttackNearest() end)
            return
        end
        self.consecutiveFailures = 0
        temp_RegisterAttack:FireServer(Settings.ClickDelay or 0.01)
        temp_RegisterHit:FireServer(BasePart, OthersEnemies)
    end

    function FastAttack:AttackNearest()
        if not self.IsRunning then return end
        local _, _, _, _, Enemies = CheckAndGetCoreComponents()
        local OthersEnemies = {}
        local Part1 = ProcessEnemies(OthersEnemies, Enemies)
        local Part2 = ProcessRealPlayers(OthersEnemies)
        if #OthersEnemies > 0 then
            self:Attack(Part1 or Part2, OthersEnemies)
        end
    end

    function FastAttack:BladeHits()
        if not self.IsRunning then return end
        local Equipped = LocalPlayer.Character and IsAlive(LocalPlayer.Character) and LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if Equipped and Equipped.ToolTip ~= "Gun" then
            self:AttackNearest()
        end
    end

    task.spawn(function()
        while true do
            task.wait(Settings.ClickDelay)
            if Settings.AutoClick and FastAttack.IsRunning then
                FastAttack:BladeHits()
            else
                task.wait(0.1)
            end
        end
    end)

    _ENV.rz_FastAttack = FastAttack
    return FastAttack
end)()

-- 秒殺 UI 控件
Tab3:AddToggle({
    Name = "秒殺開關",
    Default = _G.FastAttack,
    Callback = function(state)
        if _ENV.rz_FastAttack then
            _ENV.rz_FastAttack.IsRunning = state
            _G.FastAttack = state
        end
    end
})

Tab3:AddTextbox({
    Name = "攻擊範圍",
    Default = "100000",
    TextDisappear = false,
    Callback = function(text)
        local num = tonumber(text) or 100000
        num = math.clamp(num, 1, 1000000)
        if _ENV.rz_FastAttack then
            _ENV.rz_FastAttack.Distance = num
        end
    end
})

Tab3:AddTextbox({
    Name = "攻速延遲",
    Default = "0.01",
    TextDisappear = false,
    Callback = function(text)
        local num = tonumber(text) or 0.01
        num = math.clamp(num, 0.001, 1)
        Settings.ClickDelay = num
    end
})

Tab3:AddToggle({
    Name = "攻擊玩家",
    Default = true,
    Callback = function(state)
        if _ENV.rz_FastAttack then _ENV.rz_FastAttack.attackPlayers = state end
    end
})

-- ==================== 改進透視功能：專屬玩家 ====================
local ESPConfig = {
    MainSwitch = false,
    ShowNameDistance = true,
    ShowTracer = true,
    ShowHealth = true
}

local ESPElements = {}

local function CleanupPlayerESP(player)
    if not ESPElements[player.UserId] then return end
    if ESPElements[player.UserId].NameHealthESP then ESPElements[player.UserId].NameHealthESP:Destroy() end
    if ESPElements[player.UserId].NameHealthUpdateConn then ESPElements[player.UserId].NameHealthUpdateConn:Disconnect() end
    if ESPElements[player.UserId].Tracer then ESPElements[player.UserId].Tracer:Remove() end
    if ESPElements[player.UserId].TracerConn then ESPElements[player.UserId].TracerConn:Disconnect() end
    ESPElements[player.UserId] = nil
end

local function CreateNameDistanceHealthESP(player)
    if not player.Character or not player.Character:FindFirstChild("Head") then return end
    local head = player.Character.Head
    if ESPElements[player.UserId] and ESPElements[player.UserId].NameHealthESP then ESPElements[player.UserId].NameHealthESP:Destroy() end

    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "NameDistanceHealthESP"
    billboardGui.Adornee = head
    billboardGui.Size = UDim2.new(0, 120, 0, 50)
    billboardGui.StudsOffset = Vector3.new(0, 3.5, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.Parent = head

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Parent = billboardGui
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name
    nameLabel.Size = UDim2.new(1, 0, 0.33, 0)
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamSemibold

    local healthLabel = Instance.new("TextLabel")
    healthLabel.Parent = billboardGui
    healthLabel.BackgroundTransparency = 1
    healthLabel.Position = UDim2.new(0, 0, 0.33, 0)
    healthLabel.Size = UDim2.new(1, 0, 0.33, 0)
    healthLabel.TextColor3 = Color3.new(0, 1, 0)
    healthLabel.TextScaled = true
    healthLabel.Font = Enum.Font.Gotham

    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Parent = billboardGui
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Position = UDim2.new(0, 0, 0.66, 0)
    distanceLabel.Size = UDim2.new(1, 0, 0.33, 0)
    distanceLabel.TextColor3 = Color3.new(1, 0.5, 0)
    distanceLabel.TextScaled = true
    distanceLabel.Font = Enum.Font.Gotham

    local updateConnection = RunService.RenderStepped:Connect(function()
        if not billboardGui.Parent or not LocalPlayer.Character or not player.Character then return end
        local localRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
        if localRoot and targetRoot then
            local distance = (localRoot.Position - targetRoot.Position).Magnitude
            distanceLabel.Text = string.format("%.1f米", distance)
        end
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            local health = math.floor(humanoid.Health)
            local maxHealth = math.floor(humanoid.MaxHealth)
            local healthPercent = health / maxHealth
            if healthPercent > 0.7 then
                healthLabel.TextColor3 = Color3.new(0, 1, 0)
            elseif healthPercent > 0.3 then
                healthLabel.TextColor3 = Color3.new(1, 1, 0)
            else
                healthLabel.TextColor3 = Color3.new(1, 0, 0)
            end
            healthLabel.Text = string.format("血量: %d/%d", health, maxHealth)
        end
    end)

    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].NameHealthESP = billboardGui
    ESPElements[player.UserId].NameHealthUpdateConn = updateConnection
end

local function CreateTracerESP(player)
    if ESPElements[player.UserId] and ESPElements[player.UserId].Tracer then ESPElements[player.UserId].Tracer:Remove() end
    local tracer = Drawing.new("Line")
    tracer.Color = Color3.new(1, 0, 0)
    tracer.Thickness = 2
    tracer.Transparency = 0.8
    tracer.Visible = false

    local renderConnection = RunService.RenderStepped:Connect(function()
        if not ESPConfig.MainSwitch or not ESPConfig.ShowTracer then tracer.Visible = false return end
        local localChar = LocalPlayer.Character
        local targetChar = player.Character
        if not localChar or not targetChar then tracer.Visible = false return end
        local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
        if targetRoot then
            local screenPos, isVisible = Camera:WorldToViewportPoint(targetRoot.Position)
            if isVisible then
                tracer.Visible = true
                tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
            else
                tracer.Visible = false
            end
        else
            tracer.Visible = false
        end
    end)

    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].Tracer = tracer
    ESPElements[player.UserId].TracerConn = renderConnection
end

local function UpdatePlayerESP(player)
    if player == LocalPlayer then return end
    if not player.Character or not player.Character:FindFirstChild("Head") or not player.Character:FindFirstChild("HumanoidRootPart") then
        CleanupPlayerESP(player)
        return
    end
    if ESPConfig.MainSwitch then
        CreateTracerESP(player)
        if ESPConfig.ShowNameDistance or ESPConfig.ShowHealth then
            CreateNameDistanceHealthESP(player)
        else
            if ESPElements[player.UserId] and ESPElements[player.UserId].NameHealthESP then
                ESPElements[player.UserId].NameHealthESP:Destroy()
                ESPElements[player.UserId].NameHealthESP = nil
            end
            if ESPElements[player.UserId] and ESPElements[player.UserId].NameHealthUpdateConn then
                ESPElements[player.UserId].NameHealthUpdateConn:Disconnect()
                ESPElements[player.UserId].NameHealthUpdateConn = nil
            end
        end
    else
        CleanupPlayerESP(player)
    end
end

local function UpdateAllESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then UpdatePlayerESP(player) end
    end
end

Players.PlayerAdded:Connect(function(player)
    if player == LocalPlayer then return end
    player.CharacterAdded:Connect(function() task.wait(1) UpdatePlayerESP(player) end)
    player.CharacterRemoving:Connect(function() CleanupPlayerESP(player) end)
end)

LocalPlayer.CharacterAdded:Connect(function() task.wait(2) UpdateAllESP() end)

task.spawn(function()
    while true do
        task.wait(3)
        if ESPConfig.MainSwitch then UpdateAllESP() end
    end
end)

-- 透視 UI
Tab4:AddToggle({Name = "透視總開關 (玩家專屬)", Default = false, Callback = function(v) ESPConfig.MainSwitch = v UpdateAllESP() end})
Tab4:AddToggle({Name = "顯示名字+距離", Default = true, Callback = function(v) ESPConfig.ShowNameDistance = v UpdateAllESP() end})
Tab4:AddToggle({Name = "顯示血量", Default = true, Callback = function(v) ESPConfig.ShowHealth = v UpdateAllESP() end})
Tab4:AddToggle({Name = "射線追蹤", Default = true, Callback = function(v) ESPConfig.ShowTracer = v UpdateAllESP() end})

-- 初始化
task.spawn(function()
    task.wait(3)
    UpdateAllESP()
end)

OrionLib:Init()
