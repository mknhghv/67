local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local mouse = LocalPlayer:GetMouse()
local attacking = false

-- 攻击检测（鼠标左键）
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        attacking = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        attacking = false
    end
end)

local function isAlive(char)
    local hum = char:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health > 0
end

local function getTargetPart(char)
    if TARGET_HEAD and char:FindFirstChild("Head") then
        return char.Head
    end
    return char:FindFirstChild("HumanoidRootPart")
end

-- 找准星附近最近玩家
local function getBestTarget()
    local best, bestAngle = nil, math.rad(12)

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and isAlive(plr.Character) then
            local part = getTargetPart(plr.Character)
            if part then
                local dir = (part.Position - Camera.CFrame.Position).Unit
                local angle = math.acos(Camera.CFrame.LookVector:Dot(dir))

                local dist = (part.Position - Camera.CFrame.Position).Magnitude
                if angle < bestAngle and dist < MAX_DISTANCE then
                    bestAngle = angle
                    best = part
                end
            end
        end
    end

    return best
end

-- Aim Assist（微调）
RunService.RenderStepped:Connect(function()
    if not ENABLED then return end
    if ONLY_WHEN_ATTACK and not attacking then return end

    local target = getBestTarget()
    if not target then return end

    local camCF = Camera.CFrame
    local desiredDir = (target.Position - camCF.Position).Unit

    local newLook = camCF.LookVector:Lerp(desiredDir, ASSIST_STRENGTH)
    Camera.CFrame = CFrame.new(camCF.Position, camCF.Position + newLook)
end)
